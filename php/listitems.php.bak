<SCRIPT LANGUAGE="JavaScript"> 
$(function () {
 //$('input#itemlistfilter').quicksearch('table#itemlisttbl tbody tr');

  $('table#itemlisttbl').dataTable({
                "sPaginationType": "full_numbers",
                "bJQueryUI": true,
                "iDisplayLength": -1,
                "aLengthMenu": [[10,25, 50, 100, -1], [10,25, 50, 100, "All"]],
                "bLengthChange": true,
                "bFilter": true,
                "bSort": true,
                "bInfo": true,
                "sDom": '<"H"Tlpf>rt<"F"ip>',
                "oTableTools": {
                        "sSwfPath": "swf/copy_cvs_xls_pdf.swf"
                }

  });
});

</SCRIPT>
<?php 
if (!isset($initok)) {echo "do not run this script directly";exit;}
/* Spiros Ioannou 2009 , sivann _at_ gmail.com */

//error_reporting(E_ALL);
//ini_set('display_errors', '1');

//	Get item types
$sql="SELECT * from itemtypes order by typedesc";
$sth=db_execute($dbh,$sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $itypes[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from items order by id";
$sth=db_execute($dbh,$sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $itemlist[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from users order by username";
$sth=db_execute($dbh,$sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $userlist[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from locations order by name,floor";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $locations[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from locareas order by areaname";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $locareas[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from racks";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $racks[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from tags order by name";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $tags[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from vlans order by id";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $vlans[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * from departments order by id";
$sth=$dbh->query($sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $departments[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT id,title FROM agents";
$sth=db_execute($dbh,$sql);
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) $agents[$r['id']]=$r;
$sth->closeCursor();
$sql="SELECT * FROM statustypes";
$sth=$dbh->query($sql);
$statustypes=$sth->fetchAll(PDO::FETCH_ASSOC);
?>

<h1><?php te("Items");?> <a title='<?php te("Add new item");?>' href='<?php echo $scriptname?>?action=edititem&amp;id=new'><img border=0 src='images/add.png' ></a>
</h1>

<table class='display' border=0 id='itemlisttbl'>

<thead>
<tr>
  <th style='width:70px'><?php te("ID");?></th>
  <th><?php te("Item type");?></th>
  <th><?php te("Building [Floor]");?></th>
  <th><?php te("Area/Room");?></th>
  <th><?php te("Manufacturer");?></th>
  <th><?php te("Model");?></th>
  <th><?php te("DNS Name");?></th>
  <th><?php te("S/N");?></th>
  <th><?php te("Asset #");?></th>
  <th><?php te("Warr. Left");?></th>
  <th><?php te("Status");?></th>
  <th><?php te("MAC");?></th>
  <th><?php te("IPv4");?></th>
  <th><?php te("Ports Qty");?></th>
  </tr>
</thead>

<tbody>
<?php 
$t=time();
$sql="SELECT items.*,agents.title AS agtitle, (purchasedate+warrantymonths*30*24*60*60-$t)/(60*60*24) AS remdays FROM items, agents WHERE agents.id=items.manufacturerid $where";
$sth=db_execute($dbh,$sql);

// display results
$currow=0;
while ($r=$sth->fetch(PDO::FETCH_ASSOC)) {
$currow++;

  $sqlinv="SELECT invoices.* from invoices,item2inv where item2inv.itemid={$r['id']} AND invoices.id=item2inv.invid";
  $sthinv=db_execute($dbh,$sqlinv);
  $invoices=$sthinv->fetchAll(PDO::FETCH_ASSOC);

  $sqlsoft="SELECT software.*, software.id as softwareid , invoices.* FROM software,item2soft,invoices WHERE ".
           " item2soft.itemid={$r['id']} ".
	   " AND software.id=item2soft.softid ".
	   " AND invoices.id=software.invoiceid ";
  $sthsoft=db_execute($dbh,$sqlsoft);
  $software=$sthsoft->fetchAll(PDO::FETCH_ASSOC);

  //2seconds
  $d=strlen($r['purchasedate'])?date($dateparam,$r['purchasedate']):"-"; 

  $user=isset($userlist[$r['userid']])?$userlist[$r['userid']]['username']:"";

  if (isset($racks[$r['rackid']])) {
    $i=$r['rackid'];
    $rack=$racks[$i]['label']." ".$racks[$i]['model']." ".$racks[$i]['usize']."U";
  }
  else $rack="";


  //invoice links
  $invinfo="";
  if (isset($invoices[0]['id'])) {
    $cinv=count($invoices);
    for ($ninv=0;$ninv<$cinv;$ninv++) {
      $dinv=strlen($invoices[$ninv]['date'])?date($dateparam,$invoices[$ninv]['date']):"";
      $invinfo.="<b>&bull;</b>";
      $invinfo.="<a title='view invoice' href='$fscriptname?action=editinvoice&amp;id={$invoices[$ninv]['id']}'>".
                  "{$invoices[$ninv]['number']}</a>";
      //else $invinfo.="{$invoices[$ninv]['number']}";
      $invinfo.=" {$agents[$invoices[$ninv]['vendorid']]['title']}<span style='font-family:serif'>&rarr;</span>"; //sans-serif arrows suck for somereason
      $invinfo.="{$agents[$invoices[$ninv]['buyerid']]['title']} $dinv";
      if ($ninv<($cinv-1)) $invinfo.= "<br>";
    }
  }


 //software links
 $softinfo="<table border=1 class=brdr style='margin:0'>";
  if (isset($software[0]['softwareid'])) {
    $csof=count($software);
    for ($nsof=0;$nsof<$csof;$nsof++) {
      $softinfo.="\n<tr><td style='width:150px'><b>".($nsof+1)."</b>-";

      $softinfo.="<a title='Edit software' href='$fscriptname?action=editsoftware&amp;id={$software[$nsof]['softwareid']}'>".
		"{$software[$nsof]['scompany']}&nbsp;{$software[$nsof]['stitle']}&nbsp;{$software[$nsof]['sversion']}</a></td>";
      $invflink="<td style='width:20%'><a title='edit invoice' href='$fscriptname?action=editinvoice&amp;id={$software[$nsof]['invoiceid']}'>".
                "{$software[$nsof]['number']}</a></td>";
      $dinv=strlen($software[$nsof]['date'])?date($dateparam,$software[$nsof]['date']):"";
      $softinfo.="<td> $invflink</td>";
      $softinfo.="<td>{$agents[$software[$nsof]['vendorid']]['title']}</td>";
      $softinfo.="<td>{$agents[$software[$nsof]['buyerid']]['title']}</td><td>$dinv</td></tr>";
      //if ($nsof<($csof-1)) $softinfo.= "<br>";
    }
  }
  $softinfo.="</table>\n";


  $remdays=$r['remdays'];
  if (abs($remdays)>360) $remw=sprintf("%.1f",($remdays/360))."yr";
  else if (abs($remdays)>70) $remw=sprintf("%.1f",($remdays/30))."mon";
  else if (strlen($remdays)) $remw="$remdays"."d";
  else $remw="";
  

  if ($remdays<0) $remw="<span style='color:#F90000'>$remw</span>";
  if ($remdays>0) $remw="<span style='color:green'>$remw</span>";
  if (abs($remdays)>360*20) $remw="";



  $x=attrofstatus((int)$r['status'],$dbh);
  $attr=$x[0];
  $statustxt=$x[1];


  //table row
  if ($currow%2) $c="class='dark'";
  else $c="";

  echo "\n<tr $c>".
       "<td nowrap><span $attr>&nbsp;</span><center class='editiditm icon edit'><a href='$scriptname?action=editagent&amp;id=".$r['id']."'><img src='../images/edit2.png'></a><a href='../php/delagent.php?id=".$r['id']."'><img src='../images/delete.png' border=0></a></center></td>";

  $sn="";
  if (strlen($r['sn'])) $sn.=$r['sn'];
  if (strlen($r['sn2'])) {if (strlen($sn)) $sn.=", ";} $sn.=$r['sn2'];
  if (strlen($r['sn3'])) {if (strlen($sn)) $sn.=", ";} $sn.=$r['sn3'];

  //username
  $user=isset($userlist[$r['userid']])?$userlist[$r['userid']]['username']:"";
  if ($r['ports']) $ports=$r['ports'];


  echo "</td>".
		"\n  <td>".$itypes[$r['itemtypeid']]['typedesc']."</td>".
		"\n  <td>".$locations[$r['locationid']]['name']."</td>\n".
		"\n  <td><center>".$locareas[$r['locareaid']]['areaname']."</center></td>\n".
		"\n  <td>".$r['agtitle']."&nbsp;</td>".
		"\n  <td width='auto'><center>".$r['model']."</center></td>".
		"\n  <td><center>".$r['dnsname']."</center></td>".
		"\n  <td><center>$sn</center></td>".
		"\n  <td><center>".$r['asset']."</center></td>".
		"\n  <td class='monospaced'><center>$remw</center></td>";
		"\n  <td><center>$statustxt</center></td>";
		"\n <td><center>".$departments[$r['departmentsid']]['abbr']."</center></td>";
		"\n <td><center>".$vlans[$r['vlanid']]['vlanid']."</center></td>";
		"\n  <td>".$r['macs']."</td>";
		"\n  <td>".$r['ipv4']."</td>";
		"\n  <td><center>$ports<center></td>";}?>
</tbody>
</table>